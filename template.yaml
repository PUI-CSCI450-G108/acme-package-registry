AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: ACME Package Registry - Trustworthy Model Registry API

Globals:
  Function:
    Timeout: 300
    MemorySize: 2048
    Runtime: python3.13  # Change to match your Python version
    Environment:
      Variables:
        GIT_LFS_SKIP_SMUDGE: "1"
        HF_HUB_DISABLE_PROGRESS_BARS: "1"
        MIN_NET_SCORE: "0.5"
        # Configure HuggingFace to use Lambda's writable /tmp directory
        HF_HOME: "/tmp/huggingface"
        HUGGINGFACE_HUB_CACHE: "/tmp/huggingface/hub"
        TRANSFORMERS_CACHE: "/tmp/huggingface/transformers"
        # Add your HuggingFace token here or set via parameter
        # HF_TOKEN: !Ref HuggingFaceToken

Parameters:
  HuggingFaceToken:
    Type: String
    Description: HuggingFace API token for accessing models
    NoEcho: true
    Default: ""

Resources:
  # CloudWatch Log Group for API Gateway Access Logs
  ApiGatewayAccessLogs:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: /aws/apigateway/acme-registry-access-logs
      RetentionInDays: 7

  # HTTP API Gateway
  AcmeApiGateway:
    Type: AWS::Serverless::HttpApi
    DependsOn: ApiGatewayAccessLogs
    Properties:
      AccessLogSettings:
        DestinationArn: !GetAtt ApiGatewayAccessLogs.Arn
        Format: '{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","routeKey":"$context.routeKey","status":"$context.status","protocol":"$context.protocol","responseLength":"$context.responseLength","errorMessage":"$context.error.message","integrationErrorMessage":"$context.integrationErrorMessage"}'
      CorsConfiguration:
        AllowOrigins:
          - "*"
        AllowHeaders:
          - "content-type"
          - "x-authorization"
        AllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        MaxAge: 600
      DefaultRouteSettings:
        ThrottlingBurstLimit: 1000
        ThrottlingRateLimit: 500
        
  # S3 Bucket for artifact storage
  ArtifactsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "acme-registry-artifacts-${AWS::AccountId}"
      VersioningConfiguration:
        Status: Enabled

  # S3 Bucket for static website hosting (via CloudFront)
  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "acme-registry-frontend-${AWS::AccountId}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # CloudFront Origin Access Control for S3 bucket
  CloudFrontOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub "acme-registry-frontend-oac-${AWS::AccountId}"
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  # Bucket policy to allow CloudFront OAC access
  WebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    DependsOn: CloudFrontDistribution
    Properties:
      Bucket: !Ref WebsiteBucket
      PolicyDocument:
        Statement:
          - Sid: AllowCloudFrontServicePrincipal
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: 's3:GetObject'
            Resource: !Sub '${WebsiteBucket.Arn}/*'
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub 'arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}'

  # CloudFront Distribution for front-end
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        HttpVersion: http2
        DefaultRootObject: login.html
        Comment: ACME Package Registry Front-End Distribution
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt WebsiteBucket.RegionalDomainName
            OriginAccessControlId: !GetAtt CloudFrontOriginAccessControl.Id
            S3OriginConfig: {}
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /login.html
            ErrorCachingMinTTL: 300
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /login.html
            ErrorCachingMinTTL: 300
        PriceClass: PriceClass_100

  # Lambda Function for POST /artifact/{artifact_type}
  CreateArtifactFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.create_artifact.handler
      Description: Register a new artifact (model/dataset/code)
      FunctionName: acme-registry-create-artifact
      Environment:
        Variables:
          HF_TOKEN: !Ref HuggingFaceToken
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
          ENABLE_FULL_MODEL_DOWNLOAD: "false" #TODO: Set to desired runtime value
          THRESHOLD_ENABLED: "false"
          URL_VALIDATION_ENABLED: "false"
      Policies:
        - S3WritePolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        CreateArtifactApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /artifact/{artifact_type}
            Method: POST

  # Lambda Function for GET /artifact/model/{id}/rate
  RateArtifactFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.rate_artifact.handler
      Description: Get ratings for a model artifact
      FunctionName: acme-registry-rate-artifact
      Environment:
        Variables:
          HF_TOKEN: !Ref HuggingFaceToken
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        RateArtifactApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /artifact/model/{id}/rate
            Method: GET

  # Lambda Function for GET /health
  HealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.health_check.handler
      Description: Health check endpoint
      FunctionName: acme-registry-health-check
      Timeout: 10
      MemorySize: 128
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
      Events:
        HealthCheckApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /health
            Method: GET

  # Lambda Function for GET /health/live
  HealthCheckLiveFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.health_check_live.handler
      Description: Health check live endpoint
      FunctionName: acme-registry-health-check-live
      Timeout: 10
      MemorySize: 128
      Events:
        HealthCheckApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /health/live
            Method: GET
  # Lambda Function for PUT /authenticate
  AuthenticateFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.auth_login.handler
      Description: Issue authentication token
      FunctionName: acme-registry-authenticate
      Events:
        AuthenticateApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /authenticate
            Method: PUT

  # Lambda Function for POST /auth/register
  RegisterUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.auth_register.handler
      Description: Register new user (admin only)
      FunctionName: acme-registry-register-user
      Events:
        RegisterUserApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /auth/register
            Method: POST

  # Lambda Function for POST /auth/logout
  LogoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.auth_logout.handler
      Description: Logout active token
      FunctionName: acme-registry-logout
      Events:
        LogoutApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /auth/logout
            Method: POST

  # Lambda Function for GET /artifact/byName/{name}
  GetArtifactByNameFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.get_artifact_by_name.handler
      Description: Get artifacts by name
      FunctionName: acme-registry-get-artifact-by-name
      Timeout: 10
      MemorySize: 128
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        GetArtifactByNameApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /artifact/byName/{name}
            Method: GET

  # Lambda Function for POST /artifacts (list/query artifacts, not creation)
  ListArtifactsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.list_artifacts.handler
      Description: List artifacts with pagination and filtering
      FunctionName: acme-registry-list-artifacts
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
          ARTIFACTS_PAGE_SIZE: "50"
          ARTIFACTS_MAX_RESULTS: "250"
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        ListArtifactsApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /artifacts
            Method: POST

  # Lambda Function for POST /artifacts/detailed (list with full data including ratings)
  ListArtifactsDetailedFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.list_artifacts_detailed.handler
      Description: List artifacts with detailed information including ratings
      FunctionName: acme-registry-list-artifacts-detailed
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
          ARTIFACTS_PAGE_SIZE: "50"
          ARTIFACTS_MAX_RESULTS: "250"
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        ListArtifactsDetailedApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /artifacts/detailed
            Method: POST

  # Lambda Function for DELETE /reset
  ResetRegistryFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.reset_registry.handler
      Description: Reset registry by deleting all artifacts
      FunctionName: acme-registry-reset
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        ResetRegistryApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /reset
            Method: DELETE
  # Lambda Function for POST /artifact/search
  SearchArtifactsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.search_artifacts.handler
      Description: Search artifacts by regex and version
      FunctionName: acme-registry-search-artifacts
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        SearchArtifactsApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /artifact/search
            Method: POST

  # Lambda Function for GET /artifacts/{artifact_type}/{id}
  GetArtifactByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.get_artifact_by_id.handler
      Description: Get artifact by ID
      FunctionName: acme-registry-get-artifact-by-id
      Timeout: 10
      MemorySize: 128
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        GetArtifactByIdApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /artifacts/{artifact_type}/{id}
            Method: GET

  # Lambda Function for PUT /artifacts/{artifact_type}/{id}
  UpdateArtifactFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.update_artifact.handler
      Description: Update existing artifact
      FunctionName: acme-registry-update-artifact
      Timeout: 300
      MemorySize: 2048
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
          HF_TOKEN: !Ref HuggingFaceToken
          MIN_NET_SCORE: "0.5"
          GIT_LFS_SKIP_SMUDGE: "1"
          HF_HUB_DISABLE_PROGRESS_BARS: "1"
          HF_HOME: "/tmp/huggingface"
          HUGGINGFACE_HUB_CACHE: "/tmp/huggingface/hub"
          TRANSFORMERS_CACHE: "/tmp/huggingface/transformers"
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref ArtifactsBucket
        - S3WritePolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        UpdateArtifactApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /artifacts/{artifact_type}/{id}
            Method: PUT

  # Lambda Function for DELETE /artifacts/{artifact_type}/{id}
  DeleteArtifactFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.delete_artifact.handler
      Description: Delete artifact by ID
      FunctionName: acme-registry-delete-artifact
      Timeout: 10
      MemorySize: 128
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        DeleteArtifactApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /artifacts/{artifact_type}/{id}
            Method: DELETE

  # Lambda Function for GET /artifact/{artifact_type}/{id}/cost
  ArtifactCostFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.artifact_cost.handler
      Description: Get the cost (size in MB) of an artifact
      FunctionName: acme-registry-artifact-cost
      Timeout: 10
      MemorySize: 128
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        ArtifactCostApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /artifact/{artifact_type}/{id}/cost
            Method: GET

  # Lambda Function for GET /artifact/model/{id}/lineage
  ArtifactLineageFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.artifact_lineage.handler
      Description: Get the lineage graph for a model artifact
      FunctionName: acme-registry-artifact-lineage
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        ArtifactLineageApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /artifact/model/{id}/lineage
            Method: GET

  # Lambda Function for GET /tracks
  TracksFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.tracks.handler
      Description: Get list of planned implementation tracks
      FunctionName: acme-registry-tracks
      Timeout: 10
      MemorySize: 128
      Events:
        TracksApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /tracks
            Method: GET

    # Lambda Function for GET /audit/package-confusion
  PackageConfusionAuditFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.package_confusion_audit.handler
      Description: Detects suspected package confusion / typosquatting uploads
      FunctionName: acme-registry-package-confusion-audit
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
          # Comma-separated baselines. Tune for your ecosystem.
          TOP_PACKAGE_NAMES: "requests,numpy,pandas,torch,tensorflow,flask,react,express"
          AUDIT_SCORE_THRESHOLD: "0.60"
          MAX_AUDIT_RESULTS: "200"
          AUDIT_CODE_ONLY: "true"
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref ArtifactsBucket
      Events:
        PackageConfusionAuditApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /audit/package-confusion
            Method: GET

  # Lambda Function for GET /download /{artifact_id}
  DownloadFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambda_handlers.download.handler
      Description: Download endpoint that downloads artifact 
      FunctionName: acme-registry-download
      Timeout: 10
      MemorySize: 128
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref ArtifactsBucket
      Environment:
        Variables:
          ARTIFACTS_BUCKET: !Ref ArtifactsBucket
      Events:
        DownloadApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref AcmeApiGateway
            Path: /download/{artifact_id}
            Method: GET

Outputs:
  ApiGatewayUrl:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${AcmeApiGateway}.execute-api.${AWS::Region}.amazonaws.com"
    Export:
      Name: !Sub "${AWS::StackName}-ApiGatewayUrl"

  CreateArtifactFunctionArn:
    Description: "Create Artifact Lambda Function ARN"
    Value: !GetAtt CreateArtifactFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-CreateArtifactFunctionArn"

  CreateArtifactFunctionName:
    Description: "Create Artifact Lambda Function Name"
    Value: !Ref CreateArtifactFunction

  RateArtifactFunctionArn:
    Description: "Rate Artifact Lambda Function ARN"
    Value: !GetAtt RateArtifactFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-RateArtifactFunctionArn"

  RateArtifactFunctionName:
    Description: "Rate Artifact Lambda Function Name"
    Value: !Ref RateArtifactFunction

  HealthCheckFunctionArn:
    Description: "Health Check Lambda Function ARN"
    Value: !GetAtt HealthCheckFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-HealthCheckFunctionArn"

  HealthCheckFunctionName:
    Description: "Health Check Lambda Function Name"
    Value: !Ref HealthCheckFunction

  GetArtifactByNameFunctionArn:
    Description: "Get Artifact By Name Lambda Function ARN"
    Value: !GetAtt GetArtifactByNameFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-GetArtifactByNameFunctionArn"

  GetArtifactByNameFunctionName:
    Description: "Get Artifact By Name Lambda Function Name"
    Value: !Ref GetArtifactByNameFunction

  ArtifactsBucketName:
    Description: "S3 Bucket for artifact storage"
    Value: !Ref ArtifactsBucket

  ListArtifactsFunctionArn:
    Description: "List Artifacts Lambda Function ARN"
    Value: !GetAtt ListArtifactsFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ListArtifactsFunctionArn"

  ListArtifactsFunctionName:
    Description: "List Artifacts Lambda Function Name"
    Value: !Ref ListArtifactsFunction

  ListArtifactsDetailedFunctionArn:
    Description: "List Artifacts Detailed Lambda Function ARN"
    Value: !GetAtt ListArtifactsDetailedFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ListArtifactsDetailedFunctionArn"

  ListArtifactsDetailedFunctionName:
    Description: "List Artifacts Detailed Lambda Function Name"
    Value: !Ref ListArtifactsDetailedFunction

  ResetRegistryFunctionArn:
    Description: "Reset Registry Lambda Function ARN"
    Value: !GetAtt ResetRegistryFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ResetRegistryFunctionArn"

  ResetRegistryFunctionName:
    Description: "Reset Registry Lambda Function Name"
    Value: !Ref ResetRegistryFunction

  WebsiteBucketName:
    Description: "S3 Bucket for static website"
    Value: !Ref WebsiteBucket

  CloudFrontDistributionId:
    Description: "CloudFront Distribution ID"
    Value: !Ref CloudFrontDistribution
    Export:
      Name: !Sub "${AWS::StackName}-CloudFrontDistributionId"

  CloudFrontUrl:
    Description: "CloudFront HTTPS URL for front-end"
    Value: !Sub "https://${CloudFrontDistribution.DomainName}"
    Export:
      Name: !Sub "${AWS::StackName}-CloudFrontUrl"

  DownloadFunctionArn:
    Description: "Download Lambda Function ARN"
    Value: !GetAtt DownloadFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-DownloadFunctionArn"

  DownloadFunctionName:
    Description: "Download Lambda Function Name"
    Value: !Ref DownloadFunction
