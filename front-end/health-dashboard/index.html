<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Health Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <nav class="back-button-container" aria-label="Navigation">
    <button onclick="goBack()" class="back-btn" aria-label="Go back to main registry page">← Back to Registry</button>
  </nav>

  <main>
    <article class="health-card" aria-labelledby="service-name">
      <header class="health-header">
        <h1 class="health-title" id="service-name">Service</h1>
        <span class="badge" id="status-badge" role="status" aria-live="polite">Loading…</span>
      </header>

      <dl class="health-grid">
        <div>
          <dt class="label">Status</dt>
          <dd class="value" id="status-value">–</dd>
        </div>
        <div>
          <dt class="label">Artifacts</dt>
          <dd class="value" id="artifacts-count">–</dd>
        </div>
        <div>
          <dt class="label">Window (minutes)</dt>
          <dd class="value" id="window-minutes">–</dd>
        </div>
        <div>
          <dt class="label">Window start</dt>
          <dd class="value" id="window-start">–</dd>
        </div>
        <div>
          <dt class="label">Window end</dt>
          <dd class="value" id="window-end">–</dd>
        </div>
        <div>
          <dt class="label">Reported at</dt>
          <dd class="value" id="timestamp">–</dd>
        </div>
      </dl>

      <footer class="footer">
        <div class="status-line" role="status" aria-live="polite">
          <span class="dot" id="status-dot" aria-hidden="true"></span>
          <span id="status-text">Waiting for data…</span>
        </div>
        <div id="last-updated" role="status" aria-live="polite">Last refresh: –</div>
      </footer>

      <div class="error" id="error-message" style="display: none;" role="alert" aria-live="assertive"></div>
    </article>
  </main>

  <script>
    function goBack() {
      window.location.href = '../index.html';
    }

    const HEALTH_URL = "https://436cwsdtp3.execute-api.us-east-1.amazonaws.com/health";
    const REFRESH_MS = 15000;

    async function fetchHealth() {
      const errorEl = document.getElementById("error-message");
      errorEl.style.display = "none";
      errorEl.textContent = "";

      try {
        const res = await fetch(HEALTH_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status + " " + res.statusText);
        const data = await res.json();
        updateHealthCard(data);
      } catch (err) {
        console.error(err);
        errorEl.textContent = "Error fetching health data: " + err.message;
        errorEl.style.display = "block";
        setUnhealthyVisuals("unknown");
      } finally {
        document.getElementById("last-updated").textContent =
          "Last refresh: " + new Date().toLocaleTimeString();
      }
    }

    function updateHealthCard(data) {
      const status = (data.status || "").toLowerCase();

      document.getElementById("service-name").textContent = data.service || "Unknown service";
      document.getElementById("status-value").textContent = data.status || "unknown";
      document.getElementById("artifacts-count").textContent = data.artifacts_count ?? "–";
      document.getElementById("window-minutes").textContent = data.window_minutes ?? "–";
      document.getElementById("window-start").textContent = data.window_start || "–";
      document.getElementById("window-end").textContent = data.window_end || "–";
      document.getElementById("timestamp").textContent = data.timestamp || "–";

      if (status === "healthy") setHealthyVisuals();
      else setUnhealthyVisuals(status || "unknown");
    }

    function setHealthyVisuals() {
      const badge = document.getElementById("status-badge");
      const dot = document.getElementById("status-dot");
      const text = document.getElementById("status-text");

      badge.textContent = "Healthy";
      badge.classList.remove("badge-unhealthy");
      badge.classList.add("badge-healthy");

      dot.classList.remove("dot-unhealthy");
      dot.classList.add("dot-healthy");

      text.textContent = "System is operating normally";
    }

    function setUnhealthyVisuals(status) {
      const badge = document.getElementById("status-badge");
      const dot = document.getElementById("status-dot");
      const text = document.getElementById("status-text");

      badge.textContent = status === "unknown" ? "Unknown" : "Unhealthy";
      badge.classList.remove("badge-healthy");
      badge.classList.add("badge-unhealthy");

      dot.classList.remove("dot-healthy");
      dot.classList.add("dot-unhealthy");

      text.textContent =
        status === "unknown" ? "Unable to confirm system status" : "System requires attention";
    }

    fetchHealth();
    setInterval(fetchHealth, REFRESH_MS);
  </script>
</body>
</html>
